var widgets = require("widget");
var activeBrowserWindow = require("window-utils").activeBrowserWindow;
var {Cc, Ci} = require("chrome");
var addonName = require("self").name;

function prompt(pref, addonName, callback) {
  let message = addonName + " Add-on wants to know your location."
  let branch = Cc["@mozilla.org/preferences-service;1"]
               .getService(Ci.nsIPrefBranch2);if (branch.getPrefType(pref) === branch.PREF_STRING) {
    switch (branch.getCharPref(pref)) {
    case "always":
      return callback(true);
    case "never":
      return callback(false);
    }
  }
  let done = false;

  function remember(value, result) {
    return function () {
      done = true;
      branch.setCharPref(pref, value);
      callback(result);
    }
  }

  let self = activeBrowserWindow.PopupNotifications.show(activeBrowserWindow.gBrowser.selectedBrowser, "geolocation",
                        message, "geo-notification-icon",
    {
      label: "Share Location",
      accessKey: "S",
      callback: function (notification) {
        done = true;
        callback(true);
      }
    }, [
      {
        label: "Always Share",
        accessKey: "A",
        callback: remember("always", true)
      },
      {
        label: "Never Share",
        accessKey: "N",
        callback: remember("never", false)
      }
    ], {
      eventCallback: function (event) {
        if (event === "dismissed") {
          if (!done)
            callback(false);
          done = true;
          PopupNotifications.remove(self);
        }
      },
      persistWhileVisible: true
    });
}

var userCallback = null;

function promptCallback(allowed) {
  if (!allowed) {
    userCallback("User denied access");
  }
  else {
    var geolocation = Cc["@mozilla.org/geolocation;1"]
                        .getService(Components.interfaces.nsIDOMGeoGeolocation);
    geolocation.getCurrentPosition(userCallback);
  }
}

function getCurrentPostion() {
    var geolocation = Cc["@mozilla.org/geolocation;1"]
                        .getService(Components.interfaces.nsIDOMGeoGeolocation);
    geolocation.getCurrentPosition(userCallback);
}

function getCurrentPositionWithCheck(callback) {
  userCallback = callback;
  prompt("extensions.foo-addon.allowGeolocation", addonName, promptCallback);
}

var widget = widgets.Widget({
  id: "mozilla-link",
  label: "Mozilla website",
  contentURL: "http://www.mozilla.org/favicon.ico",
  onClick: function() {
    getCurrentPositionWithCheck(function(position) {
      if (position == "User denied access") {
        console.log(position);
      }
      else {
       console.log("latitude: ", position.coords.latitude);
       console.log("longitude: ", position.coords.longitude);
      }
    });
  }
});
